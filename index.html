<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Snippet Editor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/@ltd/j-toml@1.38.0/index.js"></script>
  <script src="https://unpkg.com/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>
  <script src="utils/toml-parser.js"></script>
  <script src="utils/var-parser.js"></script>
  <script src="components/file-list.js"></script>
  <script src="components/snippet-list.js"></script>
  <script src="components/snippet-item.js"></script>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <file-list></file-list>
    </aside>
    <main class="main">
      <header class="header">
        <h1 id="file-name-display">Pet Snippet Editor</h1>
      </header>
      <div class="snippet-list-container">
        <snippet-list></snippet-list>
      </div>
    </main>
  </div>

  <input type="file" id="file-input" accept=".toml" style="display: none;" multiple>

  <script type="module">
    // Global state
    const appState = {
      openFiles: [],
      selectedFileIndex: -1
    };

    // Global helper functions
    window.markFileDirty = function() {
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        const file = appState.openFiles[appState.selectedFileIndex];
        file.dirty = true;
        updateFileList();
      }
    };

    window.updateSnippetsInFile = function(snippets) {
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        const file = appState.openFiles[appState.selectedFileIndex];
        file.parsed.snippets = snippets;
        file.dirty = true;
        updateFileList();
        updateSnippetList();
      }
    };

    // File operations
    function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const fileObj = {
            name: file.name,
            content: e.target.result,
            parsed: null
          };

          // Parse TOML
          try {
            fileObj.parsed = window.TomlParser.parse(e.target.result);
          } catch (err) {
            console.error('Failed to parse TOML:', err);
            alert(`Failed to parse ${file.name}: ${err.message}`);
          }

          appState.openFiles.push(fileObj);
          updateFileList();

          // Auto-select first file if none selected
          if (appState.selectedFileIndex === -1) {
            selectFile(appState.openFiles.length - 1);
          }
        };
        reader.readAsText(file);
      });

      // Reset input
      event.target.value = '';
    }

    function createNewFile() {
      let counter = 1;
      let fileName = 'new.toml';

      // Check for name conflicts
      while (appState.openFiles.some(f => f.name === fileName)) {
        fileName = `new-${counter}.toml`;
        counter++;
      }

      const content = '[[snippets]]\n';
      const fileObj = {
        name: fileName,
        content: content,
        parsed: null
      };

      // Parse TOML
      try {
        fileObj.parsed = window.TomlParser.parse(content);
      } catch (err) {
        console.error('Failed to parse TOML:', err);
      }

      appState.openFiles.push(fileObj);
      updateFileList();
      selectFile(appState.openFiles.length - 1);
    }

    function selectFile(index) {
      appState.selectedFileIndex = index;
      updateFileList();
      updateHeader();
      updateSnippetList();
    }

    function closeFile(index) {
      appState.openFiles.splice(index, 1);

      // Adjust selected index
      if (appState.selectedFileIndex >= appState.openFiles.length) {
        appState.selectedFileIndex = appState.openFiles.length - 1;
      }

      updateFileList();
      updateHeader();
      updateSnippetList();
    }

    function updateFileList() {
      const fileListElement = document.querySelector('file-list');
      if (fileListElement) {
        fileListElement.render(appState.openFiles, appState.selectedFileIndex);
      }
    }

    function updateHeader() {
      const headerElement = document.getElementById('file-name-display');
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        headerElement.textContent = appState.openFiles[appState.selectedFileIndex].name;
      } else {
        headerElement.textContent = 'Pet Snippet Editor';
      }
    }

    function updateSnippetList() {
      const snippetListElement = document.querySelector('snippet-list');
      if (snippetListElement) {
        const file = appState.selectedFileIndex >= 0 ? appState.openFiles[appState.selectedFileIndex] : null;
        const snippets = file?.parsed?.snippets || [];
        snippetListElement.render(snippets);
      }
    }

    function saveFile(index) {
      if (index < 0 || index >= appState.openFiles.length) return;

      const file = appState.openFiles[index];

      try {
        // Convert parsed object back to TOML
        const tomlContent = window.TomlParser.stringify(file.parsed);

        // Create blob and download
        const blob = new Blob([tomlContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = file.name;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Clear dirty flag
        file.dirty = false;
        updateFileList();
      } catch (err) {
        console.error('Failed to save file:', err);
        alert(`Failed to save ${file.name}: ${err.message}`);
      }
    }

    // Expose functions to window for component access
    window.createNewFile = createNewFile;
    window.selectFile = selectFile;
    window.closeFile = closeFile;
    window.saveFile = saveFile;

    // Setup file input listener
    document.getElementById('file-input').addEventListener('change', handleFileUpload);
  </script>
</body>
</html>
