<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pet Snippet Editor</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/@ltd/j-toml@1.38.0/index.js"></script>
  <script src="https://unpkg.com/fuse.js@6.6.2/dist/fuse.basic.min.js"></script>
  <script src="utils/toml-parser.js"></script>
  <script src="utils/var-parser.js"></script>
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <file-list></file-list>
    </aside>
    <main class="main">
      <header class="header">
        <h1 id="file-name-display">Pet Snippet Editor</h1>
      </header>
      <div class="snippet-list-container">
        <snippet-list></snippet-list>
      </div>
    </main>
  </div>

  <input type="file" id="file-input" accept=".toml" style="display: none;" multiple>

  <script type="module">
    // Global state
    const appState = {
      openFiles: [],
      selectedFileIndex: -1
    };

    // Global helper functions
    window.markFileDirty = function() {
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        const file = appState.openFiles[appState.selectedFileIndex];
        file.dirty = true;
        updateFileList();
      }
    };

    window.updateSnippetsInFile = function(snippets) {
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        const file = appState.openFiles[appState.selectedFileIndex];
        file.parsed.snippets = snippets;
        file.dirty = true;
        updateFileList();
        updateSnippetList();
      }
    };

    // File operations
    function handleFileUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const fileObj = {
            name: file.name,
            content: e.target.result,
            parsed: null
          };

          // Parse TOML
          try {
            fileObj.parsed = window.TomlParser.parse(e.target.result);
          } catch (err) {
            console.error('Failed to parse TOML:', err);
            alert(`Failed to parse ${file.name}: ${err.message}`);
          }

          appState.openFiles.push(fileObj);
          updateFileList();

          // Auto-select first file if none selected
          if (appState.selectedFileIndex === -1) {
            selectFile(appState.openFiles.length - 1);
          }
        };
        reader.readAsText(file);
      });

      // Reset input
      event.target.value = '';
    }

    function createNewFile() {
      let counter = 1;
      let fileName = 'new.toml';

      // Check for name conflicts
      while (appState.openFiles.some(f => f.name === fileName)) {
        fileName = `new-${counter}.toml`;
        counter++;
      }

      const content = '[[snippets]]\n';
      const fileObj = {
        name: fileName,
        content: content,
        parsed: null
      };

      // Parse TOML
      try {
        fileObj.parsed = window.TomlParser.parse(content);
      } catch (err) {
        console.error('Failed to parse TOML:', err);
      }

      appState.openFiles.push(fileObj);
      updateFileList();
      selectFile(appState.openFiles.length - 1);
    }

    function selectFile(index) {
      appState.selectedFileIndex = index;
      updateFileList();
      updateHeader();
      updateSnippetList();
    }

    function closeFile(index) {
      appState.openFiles.splice(index, 1);

      // Adjust selected index
      if (appState.selectedFileIndex >= appState.openFiles.length) {
        appState.selectedFileIndex = appState.openFiles.length - 1;
      }

      updateFileList();
      updateHeader();
      updateSnippetList();
    }

    function updateFileList() {
      const fileListElement = document.querySelector('file-list');
      if (fileListElement) {
        fileListElement.render(appState.openFiles, appState.selectedFileIndex);
      }
    }

    function updateHeader() {
      const headerElement = document.getElementById('file-name-display');
      if (appState.selectedFileIndex >= 0 && appState.selectedFileIndex < appState.openFiles.length) {
        headerElement.textContent = appState.openFiles[appState.selectedFileIndex].name;
      } else {
        headerElement.textContent = 'Pet Snippet Editor';
      }
    }

    function updateSnippetList() {
      const snippetListElement = document.querySelector('snippet-list');
      if (snippetListElement) {
        const file = appState.selectedFileIndex >= 0 ? appState.openFiles[appState.selectedFileIndex] : null;
        const snippets = file?.parsed?.snippets || [];
        snippetListElement.render(snippets);
      }
    }

    // File List Component
    class FileList extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      connectedCallback() {
        this.render([], -1);
      }

      render(files, selectedIndex) {
        this.shadowRoot.innerHTML = `
          <link rel="stylesheet" href="styles.css">
          <style>
            :host {
              display: block;
            }
            .file-controls {
              padding: 1rem;
              border-bottom: 1px solid #ddd;
              display: flex;
              flex-direction: column;
              gap: 0.5rem;
            }
            .file-list {
              padding: 0.5rem;
            }
            .file-item {
              padding: 0.75rem;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            .file-item.selected {
              background-color: #e3f2fd;
              border-left: 3px solid #2196f3;
              padding-left: calc(0.75rem - 3px);
            }
            .file-name {
              flex: 1;
              font-size: 13px;
              word-break: break-word;
            }
            .file-name.dirty::after {
              content: ' *';
              color: #f44336;
              font-weight: bold;
            }
            .file-actions {
              display: flex;
              gap: 0.25rem;
            }
          </style>
          <div class="file-controls">
            <button class="btn btn-primary" id="upload-btn">Upload TOML</button>
            <button class="btn" id="new-btn">New File</button>
          </div>
          <div class="file-list">
            ${files.length === 0 ? '<div style="padding: 1rem; color: #999; font-size: 13px;">No files open</div>' : ''}
            ${files.map((file, index) => `
              <div class="file-item ${index === selectedIndex ? 'selected' : ''}">
                <div class="file-name ${file.dirty ? 'dirty' : ''}">${this.escapeHtml(file.name)}</div>
                <div class="file-actions">
                  ${index !== selectedIndex ? `<button class="btn btn-small" data-select="${index}">Select</button>` : ''}
                  <button class="btn btn-small btn-danger" data-close="${index}">Close</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        // Attach event listeners
        this.shadowRoot.getElementById('upload-btn').addEventListener('click', () => {
          document.getElementById('file-input').click();
        });

        this.shadowRoot.getElementById('new-btn').addEventListener('click', createNewFile);

        this.shadowRoot.querySelectorAll('[data-select]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.select);
            selectFile(index);
          });
        });

        this.shadowRoot.querySelectorAll('[data-close]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.close);
            closeFile(index);
          });
        });
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Snippet List Component
    class SnippetList extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
        this.allSnippets = [];
        this.filteredSnippets = [];
        this.selectedIndices = new Set();
        this.searchQuery = '';
        this.selectedTags = new Set();
        this.tagMatchMode = 'any'; // 'any' or 'all'
        this.fuse = null;
      }

      connectedCallback() {
        this.render([]);
      }

      render(snippets, resetFilters = true) {
        this.allSnippets = snippets;

        // Reset filters when switching files
        if (resetFilters) {
          this.selectedTags.clear();
          this.searchQuery = '';
          this.fuse = null;
        }

        this.applyFilters();
        this.renderUI();
      }

      applyFilters() {
        let filtered = [...this.allSnippets];

        // Apply tag filter
        if (this.selectedTags.size > 0) {
          filtered = filtered.filter(snippet => {
            const snippetTags = snippet.tag || [];
            if (this.tagMatchMode === 'all') {
              return Array.from(this.selectedTags).every(tag => snippetTags.includes(tag));
            } else {
              return Array.from(this.selectedTags).some(tag => snippetTags.includes(tag));
            }
          });
        }

        // Apply search filter
        if (this.searchQuery.trim()) {
          if (!this.fuse) {
            this.fuse = new Fuse(filtered, {
              keys: ['description', 'command'],
              threshold: 0.3,
              includeScore: true
            });
          } else {
            this.fuse.setCollection(filtered);
          }
          const results = this.fuse.search(this.searchQuery);
          filtered = results.map(r => r.item);
        }

        this.filteredSnippets = filtered;
      }

      renderUI() {
        const allTags = this.getAllTags();
        const allSelected = this.filteredSnippets.length > 0 &&
                           this.filteredSnippets.every((_, i) => this.selectedIndices.has(i));

        this.shadowRoot.innerHTML = `
          <link rel="stylesheet" href="styles.css">
          <style>
            :host {
              display: block;
            }
            .controls-header {
              background-color: #fff;
              border-bottom: 2px solid #ddd;
              padding: 1rem 1.5rem;
              display: flex;
              flex-wrap: wrap;
              gap: 1rem;
              align-items: center;
              position: sticky;
              top: 0;
              z-index: 10;
            }
            .control-group {
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            .control-group label {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              font-size: 14px;
              cursor: pointer;
            }
            .search-input {
              padding: 0.5rem;
              border: 1px solid #ccc;
              border-radius: 4px;
              font-size: 14px;
              min-width: 250px;
            }
            .tag-filter {
              position: relative;
            }
            .tag-dropdown {
              position: absolute;
              top: 100%;
              left: 0;
              background: #fff;
              border: 1px solid #ccc;
              border-radius: 4px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              max-height: 300px;
              overflow-y: auto;
              min-width: 200px;
              z-index: 100;
              display: none;
            }
            .tag-dropdown.open {
              display: block;
            }
            .tag-option {
              padding: 0.5rem 1rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            .tag-option:hover {
              background-color: #f5f5f5;
            }
            .tag-option input {
              cursor: pointer;
            }
            .snippet-list {
              max-width: 1200px;
              margin: 0 auto;
              padding: 1rem;
            }
            .empty-state {
              text-align: center;
              padding: 3rem 1rem;
              color: #999;
            }
          </style>
          <div class="controls-header">
            <div class="control-group">
              <label>
                <input type="checkbox" id="select-all" ${allSelected ? 'checked' : ''}>
                <span>Select All</span>
              </label>
            </div>
            <div class="control-group">
              <button class="btn btn-primary" id="copy-selected">Copy Selected</button>
              <button class="btn btn-danger" id="delete-selected">Delete Selected</button>
            </div>
            <div class="control-group tag-filter">
              <button class="btn" id="tag-filter-btn">Tags (${this.selectedTags.size})</button>
              <button class="btn btn-small" id="tag-mode-toggle">${this.tagMatchMode === 'all' ? 'All' : 'Any'}</button>
              <div class="tag-dropdown" id="tag-dropdown">
                ${allTags.length === 0 ? '<div style="padding: 1rem; color: #999;">No tags available</div>' : ''}
                ${allTags.map(tag => `
                  <label class="tag-option">
                    <input type="checkbox" value="${this.escapeHtml(tag)}" ${this.selectedTags.has(tag) ? 'checked' : ''}>
                    <span>${this.escapeHtml(tag)}</span>
                  </label>
                `).join('')}
              </div>
            </div>
            <div class="control-group">
              <input type="text" class="search-input" id="search-input" placeholder="Search snippets..." value="${this.escapeHtml(this.searchQuery)}">
            </div>
          </div>
          <div class="snippet-list">
            ${this.filteredSnippets.length === 0 ?
              '<div class="empty-state">' + (this.allSnippets.length === 0 ? 'No snippets in this file' : 'No snippets match the current filters') + '</div>' :
              this.filteredSnippets.map((snippet, index) => `
                <snippet-item data-index="${index}"></snippet-item>
              `).join('')
            }
          </div>
        `;

        // Attach event listeners
        this.shadowRoot.getElementById('select-all').addEventListener('change', (e) => {
          if (e.target.checked) {
            this.filteredSnippets.forEach((_, i) => this.selectedIndices.add(i));
          } else {
            this.selectedIndices.clear();
          }
          this.renderUI();
        });

        this.shadowRoot.getElementById('copy-selected').addEventListener('click', () => {
          console.log('Copy selected clicked (stub)');
          alert('Copy selected functionality will be implemented in a later phase');
        });

        this.shadowRoot.getElementById('delete-selected').addEventListener('click', () => {
          console.log('Delete selected clicked (stub)');
          alert('Delete selected functionality will be implemented in a later phase');
        });

        const tagFilterBtn = this.shadowRoot.getElementById('tag-filter-btn');
        const tagDropdown = this.shadowRoot.getElementById('tag-dropdown');

        tagFilterBtn.addEventListener('click', () => {
          tagDropdown.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        this.shadowRoot.addEventListener('click', (e) => {
          if (!e.target.closest('.tag-filter')) {
            tagDropdown.classList.remove('open');
          }
        });

        this.shadowRoot.getElementById('tag-mode-toggle').addEventListener('click', () => {
          this.tagMatchMode = this.tagMatchMode === 'all' ? 'any' : 'all';
          this.applyFilters();
          this.renderUI();
        });

        tagDropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', (e) => {
            const tag = e.target.value;
            if (e.target.checked) {
              this.selectedTags.add(tag);
            } else {
              this.selectedTags.delete(tag);
            }
            this.applyFilters();
            this.renderUI();
          });
        });

        const searchInput = this.shadowRoot.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
          this.searchQuery = e.target.value;
          this.fuse = null; // Reset fuse instance
          this.applyFilters();
          this.renderUI();
          // Restore focus to search input after re-render
          requestAnimationFrame(() => {
            const newSearchInput = this.shadowRoot.getElementById('search-input');
            if (newSearchInput) {
              newSearchInput.focus();
              // Restore cursor position
              newSearchInput.setSelectionRange(this.searchQuery.length, this.searchQuery.length);
            }
          });
        });

        // Render snippet items
        const snippetItems = this.shadowRoot.querySelectorAll('snippet-item');
        snippetItems.forEach((item, index) => {
          const isSelected = this.selectedIndices.has(index);
          item.render(
            this.filteredSnippets[index],
            index,
            isSelected,
            // onCheckChange
            (idx, checked) => {
              if (checked) {
                this.selectedIndices.add(idx);
              } else {
                this.selectedIndices.delete(idx);
              }
              this.renderUI();
            },
            // onEdit
            (idx, field, value) => {
              this.filteredSnippets[idx][field] = value;
              // Mark file as dirty
              window.markFileDirty();
              // If tags were modified, re-render to update tag dropdown
              if (field === 'tag') {
                this.renderUI();
              }
            },
            // onDelete
            (idx) => {
              // Remove from allSnippets array
              const snippetToDelete = this.filteredSnippets[idx];
              const allIndex = this.allSnippets.indexOf(snippetToDelete);
              if (allIndex > -1) {
                this.allSnippets.splice(allIndex, 1);
              }
              // Update global state
              window.updateSnippetsInFile(this.allSnippets);
              // Re-render without resetting filters (we're still in the same file)
              this.render(this.allSnippets, false);
            },
            // onCopy (stub for now)
            (idx) => {
              console.log('Copy snippet at index', idx);
              alert('Copy snippet functionality will be implemented in a later phase');
            }
          );
        });
      }

      getAllTags() {
        const tagSet = new Set();
        this.allSnippets.forEach(snippet => {
          (snippet.tag || []).forEach(tag => tagSet.add(tag));
        });
        return Array.from(tagSet).sort();
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Snippet Item Component
    class SnippetItem extends HTMLElement {
      constructor() {
        super();
        this.attachShadow({ mode: 'open' });
      }

      render(snippet, index, isSelected = false, onCheckChange = null, onEdit = null, onDelete = null, onCopy = null) {
        this.onCheckChange = onCheckChange;
        this.onEdit = onEdit;
        this.onDelete = onDelete;
        this.onCopy = onCopy;
        this.index = index;
        this.snippet = snippet;

        const isEven = index % 2 === 0;
        const tags = snippet.tag || [];
        const output = snippet.output || '';

        // Parse variables from command
        this.variables = window.VarParser.parseVariables(snippet.command || '');
        this.variablesExpanded = this.variablesExpanded || false;

        // Determine highlight class based on selection and zebra
        let highlightClass = '';
        if (isSelected) {
          highlightClass = isEven ? 'highlight-blue1' : 'highlight-blue2';
        } else {
          highlightClass = isEven ? 'zebra-even' : 'zebra-odd';
        }

        this.shadowRoot.innerHTML = `
          <link rel="stylesheet" href="styles.css">
          <style>
            :host {
              display: block;
              margin-bottom: 1rem;
            }
            .snippet-container {
              border: 1px solid #ddd;
              border-radius: 4px;
              overflow: hidden;
              transition: all 0.2s ease;
            }
            .snippet-header {
              padding: 0.75rem 1rem;
              font-weight: 600;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 0.75rem;
            }
            .snippet-header input[type="checkbox"] {
              cursor: pointer;
            }
            .snippet-title-input {
              flex: 1;
              border: 1px solid #ddd;
              border-radius: 4px;
              padding: 0.5rem;
              font-size: 14px;
              font-weight: 600;
              background-color: #fff;
            }
            .snippet-title-input:focus {
              outline: none;
              border-color: #2196f3;
            }
            .snippet-actions {
              display: flex;
              gap: 0.25rem;
            }
            .snippet-body {
              padding: 1rem;
              background-color: #fff;
            }
            .snippet-field {
              margin-bottom: 1rem;
            }
            .snippet-field:last-child {
              margin-bottom: 0;
            }
            .field-label {
              font-size: 12px;
              font-weight: 600;
              color: #666;
              margin-bottom: 0.25rem;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }
            .field-value textarea {
              width: 100%;
              min-height: 80px;
              background-color: #f5f5f5;
              padding: 0.75rem;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              font-size: 13px;
              line-height: 1.5;
              resize: vertical;
            }
            .field-value textarea:focus {
              outline: none;
              border-color: #2196f3;
              background-color: #fff;
            }
            .field-value ul {
              list-style: none;
              padding: 0;
              margin: 0;
              display: flex;
              flex-wrap: wrap;
              gap: 0.5rem;
              align-items: center;
            }
            .tag-item {
              background-color: #e3f2fd;
              color: #1976d2;
              padding: 0.25rem 0.75rem;
              border-radius: 12px;
              font-size: 12px;
              font-weight: 500;
              display: flex;
              align-items: center;
              gap: 0.5rem;
            }
            .tag-remove {
              background: none;
              border: none;
              color: #1976d2;
              cursor: pointer;
              padding: 0;
              font-size: 14px;
              line-height: 1;
              font-weight: bold;
            }
            .tag-remove:hover {
              color: #d32f2f;
            }
            .tag-add-container {
              display: flex;
              gap: 0.5rem;
              align-items: center;
            }
            .tag-input {
              padding: 0.25rem 0.5rem;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 12px;
            }
            .tag-input:focus {
              outline: none;
              border-color: #2196f3;
            }
            .output-textarea {
              width: 100%;
              min-height: 60px;
              background-color: #f5f5f5;
              padding: 0.75rem;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              font-size: 13px;
              line-height: 1.5;
              resize: vertical;
            }
            .output-textarea:focus {
              outline: none;
              border-color: #2196f3;
              background-color: #fff;
            }
            .field-value pre {
              background-color: #f5f5f5;
              padding: 0.75rem;
              border-radius: 4px;
              overflow-x: auto;
              margin: 0;
              font-family: 'Courier New', monospace;
              font-size: 13px;
              line-height: 1.5;
            }
            .variables-header {
              cursor: pointer;
              user-select: none;
            }
            .variables-toggle {
              display: inline-flex;
              align-items: center;
              gap: 0.5rem;
            }
            .triangle {
              display: inline-block;
              transition: transform 0.2s ease;
              font-size: 10px;
            }
            .triangle.expanded {
              transform: rotate(90deg);
            }
            .variables-section {
              display: none;
              margin-top: 0.5rem;
              padding: 0.75rem;
              background-color: #f9f9f9;
              border-radius: 4px;
            }
            .variables-section.expanded {
              display: block;
            }
            .variable-item {
              margin-bottom: 1rem;
              padding: 0.75rem;
              background-color: #fff;
              border-radius: 4px;
              border: 1px solid #e0e0e0;
            }
            .variable-item:last-child {
              margin-bottom: 0;
            }
            .variable-name {
              padding: 0.5rem;
              margin-bottom: 0.5rem;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              font-size: 13px;
            }
            .variable-values {
              display: flex;
              flex-direction: column;
              gap: 0.5rem;
            }
            .variable-value-row {
              display: flex;
              gap: 0.5rem;
              align-items: center;
            }
            .variable-input {
              flex: 1;
              padding: 0.5rem;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 13px;
              font-family: 'Courier New', monospace;
            }
            .variable-input:focus {
              outline: none;
              border-color: #2196f3;
            }
          </style>
          <div class="snippet-container">
            <div class="snippet-header ${highlightClass}">
              <input type="checkbox" id="snippet-checkbox" ${isSelected ? 'checked' : ''}>
              <input type="text" class="snippet-title-input" id="description-input" value="${this.escapeAttr(snippet.description || '')}" placeholder="Enter description">
              <div class="snippet-actions">
                <button class="btn btn-small" id="copy-btn">Copy</button>
                <button class="btn btn-small btn-danger" id="delete-btn">Delete</button>
              </div>
            </div>
            <div class="snippet-body">
              <div class="snippet-field">
                <div class="field-label">Command</div>
                <div class="field-value">
                  <textarea id="command-input">${this.escapeHtml(snippet.command || '')}</textarea>
                </div>
              </div>
              <div class="snippet-field">
                <div class="field-label">Tags</div>
                <div class="field-value">
                  <ul id="tags-list">
                    ${tags.map((tag, tagIndex) => `
                      <li class="tag-item">
                        <span>${this.escapeHtml(tag)}</span>
                        <button class="tag-remove" data-tag-index="${tagIndex}" title="Remove tag">&times;</button>
                      </li>
                    `).join('')}
                    <li class="tag-add-container">
                      <button class="btn btn-small" id="show-tag-input">+ Add Tag</button>
                      <input type="text" class="tag-input" id="tag-input" placeholder="Tag name" style="display: none;">
                      <button class="btn btn-small btn-primary" id="add-tag-btn" style="display: none;">Add</button>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="snippet-field">
                <div class="field-label variables-header">
                  <span class="variables-toggle" id="variables-toggle">
                    <span class="triangle ${this.variablesExpanded ? 'expanded' : ''}">\u25B6</span>
                    Variables (${this.variables.length})
                  </span>
                </div>
                <div class="variables-section ${this.variablesExpanded ? 'expanded' : ''}" id="variables-section">
                  ${this.variables.length === 0 ? `
                    <div style="padding: 1rem; color: #999; font-size: 13px; text-align: center;">
                      No variables found. Use &lt;varname&gt; syntax in command.
                    </div>
                  ` : `
                    ${this.variables.map((varObj, varIdx) => `
                      <div class="variable-item">
                        <div class="variable-name" style="background-color: ${varObj.color}20; border-left: 3px solid ${varObj.color};">
                          <span style="color: ${varObj.color}; font-weight: bold;">&lt;${this.escapeHtml(varObj.name)}&gt;</span>
                        </div>
                        <div class="variable-values">
                          ${varObj.isList ? `
                            ${varObj.listValues.map((val, valIdx) => `
                              <div class="variable-value-row">
                                <input type="text" class="variable-input" data-var-idx="${varIdx}" data-val-idx="${valIdx}" value="${this.escapeAttr(val)}" placeholder="Value ${valIdx + 1}">
                                <button class="btn btn-small btn-danger" data-remove-val="${varIdx}-${valIdx}" title="Remove value">&minus;</button>
                              </div>
                            `).join('')}
                            <button class="btn btn-small" data-add-val="${varIdx}">+ Add Value</button>
                          ` : `
                            <div class="variable-value-row">
                              <input type="text" class="variable-input" data-var-idx="${varIdx}" data-val-idx="0" value="${this.escapeAttr(varObj.value)}" placeholder="Value">
                              <button class="btn btn-small" data-make-list="${varIdx}">Make List</button>
                            </div>
                          `}
                        </div>
                      </div>
                    `).join('')}
                  `}
                </div>
              </div>
              <div class="snippet-field">
                <div class="field-label">Output</div>
                <div class="field-value">
                  <textarea class="output-textarea" id="output-input" placeholder="Expected output (optional)">${this.escapeHtml(output)}</textarea>
                </div>
              </div>
            </div>
          </div>
        `;

        // Attach checkbox listener
        if (this.onCheckChange) {
          this.shadowRoot.getElementById('snippet-checkbox').addEventListener('change', (e) => {
            this.onCheckChange(this.index, e.target.checked);
          });
        }

        // Attach edit listeners
        const descInput = this.shadowRoot.getElementById('description-input');
        const cmdInput = this.shadowRoot.getElementById('command-input');
        const outputInput = this.shadowRoot.getElementById('output-input');

        if (this.onEdit) {
          descInput.addEventListener('input', (e) => {
            this.snippet.description = e.target.value;
            this.onEdit(this.index, 'description', e.target.value);
          });

          cmdInput.addEventListener('input', (e) => {
            this.snippet.command = e.target.value;
            this.onEdit(this.index, 'command', e.target.value);
            // Re-parse variables when command changes but don't re-render unless count changed
            const oldVarCount = this.variables.length;
            this.variables = window.VarParser.parseVariables(e.target.value);
            if (this.variables.length !== oldVarCount) {
              // Re-render when variable count changes to update the variables section
              const cursorPos = e.target.selectionStart;
              requestAnimationFrame(() => {
                this.render(this.snippet, this.index, this.shadowRoot.querySelector('#snippet-checkbox')?.checked || false, this.onCheckChange, this.onEdit, this.onDelete, this.onCopy);
                // Restore focus to command input
                const newCmdInput = this.shadowRoot.getElementById('command-input');
                if (newCmdInput) {
                  newCmdInput.focus();
                  newCmdInput.setSelectionRange(cursorPos, cursorPos);
                }
              });
            }
          });

          outputInput.addEventListener('input', (e) => {
            this.snippet.output = e.target.value;
            this.onEdit(this.index, 'output', e.target.value);
          });
        }

        // Attach variables section listeners
        const variablesToggle = this.shadowRoot.getElementById('variables-toggle');
        if (variablesToggle) {
          variablesToggle.addEventListener('click', () => {
            this.variablesExpanded = !this.variablesExpanded;
            this.render(this.snippet, this.index, this.shadowRoot.querySelector('#snippet-checkbox')?.checked || false, this.onCheckChange, this.onEdit, this.onDelete, this.onCopy);
          });

          // Variable value inputs
          this.shadowRoot.querySelectorAll('.variable-input').forEach(input => {
            input.addEventListener('input', (e) => {
              const varIdx = parseInt(e.target.dataset.varIdx);
              const valIdx = parseInt(e.target.dataset.valIdx);
              const varObj = this.variables[varIdx];

              if (varObj.isList) {
                varObj.listValues[valIdx] = e.target.value;
              } else {
                varObj.value = e.target.value;
              }

              // Update command with new values
              this.snippet.command = window.VarParser.updateCommand(this.snippet.command, this.variables);
              cmdInput.value = this.snippet.command;

              if (this.onEdit) {
                this.onEdit(this.index, 'command', this.snippet.command);
              }
            });
          });

          // Add value button (for lists)
          this.shadowRoot.querySelectorAll('[data-add-val]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const varIdx = parseInt(e.target.dataset.addVal);
              this.variables[varIdx].listValues.push('');
              this.render(this.snippet, this.index, this.shadowRoot.querySelector('#snippet-checkbox')?.checked || false, this.onCheckChange, this.onEdit, this.onDelete, this.onCopy);
            });
          });

          // Remove value button (for lists)
          this.shadowRoot.querySelectorAll('[data-remove-val]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const [varIdx, valIdx] = e.target.dataset.removeVal.split('-').map(Number);
              const varObj = this.variables[varIdx];
              if (varObj.listValues.length > 1) {
                varObj.listValues.splice(valIdx, 1);
                // Update command
                this.snippet.command = window.VarParser.updateCommand(this.snippet.command, this.variables);
                cmdInput.value = this.snippet.command;
                if (this.onEdit) {
                  this.onEdit(this.index, 'command', this.snippet.command);
                }
                this.render(this.snippet, this.index, this.shadowRoot.querySelector('#snippet-checkbox')?.checked || false, this.onCheckChange, this.onEdit, this.onDelete, this.onCopy);
              }
            });
          });

          // Make list button
          this.shadowRoot.querySelectorAll('[data-make-list]').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const varIdx = parseInt(e.target.dataset.makeList);
              const varObj = this.variables[varIdx];
              varObj.isList = true;
              varObj.listValues = [varObj.value || '', ''];
              varObj.value = '';
              // Update command
              this.snippet.command = window.VarParser.updateCommand(this.snippet.command, this.variables);
              cmdInput.value = this.snippet.command;
              if (this.onEdit) {
                this.onEdit(this.index, 'command', this.snippet.command);
              }
              this.render(this.snippet, this.index, this.shadowRoot.querySelector('#snippet-checkbox')?.checked || false, this.onCheckChange, this.onEdit, this.onDelete, this.onCopy);
            });
          });
        }

        // Attach tag management listeners
        const showTagInputBtn = this.shadowRoot.getElementById('show-tag-input');
        const tagInput = this.shadowRoot.getElementById('tag-input');
        const addTagBtn = this.shadowRoot.getElementById('add-tag-btn');

        showTagInputBtn.addEventListener('click', () => {
          showTagInputBtn.style.display = 'none';
          tagInput.style.display = 'inline-block';
          addTagBtn.style.display = 'inline-block';
          tagInput.focus();
        });

        const addTag = () => {
          const tagValue = tagInput.value.trim();
          if (tagValue && !this.snippet.tag.includes(tagValue)) {
            this.snippet.tag.push(tagValue);
            if (this.onEdit) {
              this.onEdit(this.index, 'tag', this.snippet.tag);
              // The parent will re-render everything including this item, updating the tag dropdown
            }
          }
        };

        addTagBtn.addEventListener('click', addTag);
        tagInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            addTag();
          }
        });

        // Attach tag remove listeners
        this.shadowRoot.querySelectorAll('.tag-remove').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const tagIndex = parseInt(e.target.dataset.tagIndex);
            this.snippet.tag.splice(tagIndex, 1);
            if (this.onEdit) {
              this.onEdit(this.index, 'tag', this.snippet.tag);
              // The parent will re-render everything including this item, updating the tag dropdown
            }
          });
        });

        // Attach action button listeners
        this.shadowRoot.getElementById('copy-btn').addEventListener('click', () => {
          if (this.onCopy) {
            this.onCopy(this.index);
          } else {
            console.log('Copy snippet clicked (stub)');
            alert('Copy snippet functionality will be implemented in a later phase');
          }
        });

        this.shadowRoot.getElementById('delete-btn').addEventListener('click', () => {
          if (this.onDelete) {
            if (confirm('Delete this snippet?')) {
              this.onDelete(this.index);
            }
          }
        });
      }

      escapeAttr(text) {
        return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Register components
    customElements.define('file-list', FileList);
    customElements.define('snippet-list', SnippetList);
    customElements.define('snippet-item', SnippetItem);

    // Setup file input listener
    document.getElementById('file-input').addEventListener('change', handleFileUpload);
  </script>
</body>
</html>
